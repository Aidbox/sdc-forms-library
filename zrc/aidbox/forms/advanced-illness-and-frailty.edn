{ns aidbox.forms.advanced-illness-and-frailty
 import #{zenbox aidbox.sdc aidbox.sdc.fhir}

 ;;
 ;; Advanced Illness & Frailty
 ;;

 AdvancedIllnessAndFrailtyDocument
 {:zen/tags #{zen/schema aidbox.sdc/doc aidbox.sdc/rules}
  :source {:uri "https://www.ncbi.nlm.nih.gov/pmc/articles/PMC314375"}
  :zen/desc "This form is a brief, self-report screening instrument that can be used to identify patients most likely to have bipolar disorder."
  :type zen/map
  :confirms #{aidbox.sdc/Document}
  :keys {:advanced-illness-diagnoses
         {:type zen/vector
          :sdc-type aidbox.sdc/choice
          :text "Advanced Illness Diagnoses"
          :every {:text "Advanced Illness Diagnoses"
                  :enum [{:value {:display "Alcoholic hepatitis", :code "Alcoholic hepatitis", :system "https://loinc.org"}}
                         {:value {:display "Amyotrophic lateral sclerosis", :code "Amyotrophic lateral sclerosis", :system "http://loinc.org"}}
                         {:value {:display "Alzheimer's disease", :code "Alzheimer's disease", :system "http://loinc.org"}}
                         {:value {:display "Brain cancer", :code "Brain cancer", :system "http://loinc.org"}}
                         {:value {:display "Chronic respiratory failure", :code "Chronic respiratory failure", :system "http://loinc.org"}}
                         {:value {:display "Cirrhosis of liver", :code "Cirrhosis of liver", :system "http://loinc.org"}}
                         {:value {:display "CKD stage 5", :code "CKD stage 5", :system "http://loinc.org"}}
                         {:value {:display "Congestive heart failure", :code "Congestive heart failure", :system "http://loinc.org"}}
                         {:value {:display "Dementia", :code "Dementia", :system "http://loinc.org"}}
                         {:value {:display "Emphysema", :code "Emphysema", :system "http://loinc.org"}}
                         {:value {:display "End-stage renal disease", :code "End-stage renal disease", :system "http://loinc.org"}}
                         {:value {:display "Leukemia (acute)", :code "Leukemia (acute)", :system "http://loinc.org"}}
                         {:value {:display "Metastatic cancer", :code "Metastatic cancer", :system "http://loinc.org"}}
                         {:value {:display "Pancreatic cancer", :code "Pancreatic cancer", :system "http://loinc.org"}}
                         {:value {:display "Parkinson's disease", :code "Parkinson's disease", :system "http://loinc.org"}}
                         {:value {:display "Pulmonary fibrosis", :code "Pulmonary fibrosis", :system "http://loinc.org"}}]}}

         :frailty-diagnoses
         {:type zen/vector
          :text "Advanced Illness Diagnoses"
          :sdc-type aidbox.sdc/choice
          :every {:text "Frailty Diagnoses"
                  :enum [{:value {:display "Age-related cognitive decline without dementia", :code "Age-related cognitive decline without dementia", :system "https://loinc.org"}}
                         {:value {:display "Age-related physical debility", :code "Age-related physical debility", :system "http://loinc.org"}}
                         {:value {:display "At risk for falling", :code "At risk for falling", :system "http://loinc.org"}}
                         {:value {:display "Bed confinement status", :code "Bed confinement status", :system "http://loinc.org"}}
                         {:value {:display "Cachexia", :code "Cachexia", :system "http://loinc.org"}}
                         {:value {:display "Difficulty walking", :code "Difficulty walking", :system "http://loinc.org"}}
                         {:value {:display "Failure to thrive", :code "Failure to thrive", :system "http://loinc.org"}}
                         {:value {:display "Frailty", :code "Frailty", :system "http://loinc.org"}}
                         {:value {:display "Generalized weakness", :code "Generalized weakness", :system "http://loinc.org"}}
                         {:value {:display "History of fall", :code "History of fall", :system "http://loinc.org"}}
                         {:value {:display "Limitation of activity due to disability", :code "Limitation of activity due to disability", :system "http://loinc.org"}}
                         {:value {:display "Need for assistance with ADLs", :code "Need for assistance with ADLs", :system "http://loinc.org"}}
                         {:value {:display "Need for continuous supervision", :code "Need for continuous supervision", :system "http://loinc.org"}}
                         {:value {:display "Oxygen dependence", :code "Oxygen dependence", :system "http://loinc.org"}}
                         {:value {:display "Pressure ulcer (any severity)", :code "Pressure ulcer (any severity)", :system "http://loinc.org"}}
                         {:value {:display "Reduced mobility", :code "Reduced mobility", :system "http://loinc.org"}}
                         {:value {:display "Respirator/ventilator dependence", :code "Respirator/ventilator dependence", :system "http://loinc.org"}}
                         {:value {:display "Underweight", :code "Underweight", :system "http://loinc.org"}}
                         {:value {:display "Wheelchair dependence", :code "Wheelchair dependence", :system "http://loinc.org"}}]}}}}

 AdvancedIllnessAndFrailtyLayout
 {:zen/tags #{aidbox.sdc/Layout aidbox.sdc/rules}
  :document AdvancedIllnessAndFrailtyDocument
  :engine aidbox.sdc/Hiccup
  :layout {:type aidbox.sdc/fields
           :children [{:type aidbox.sdc/label :label "**Please document all advanced illness and frailty diagnoses.**"}
                      {:bind [:advanced-illness-diagnoses]}
                      {:bind [:frailty-diagnoses]}]}}

 AdvancedIllnessAndFrailtyLaunch
 {:zen/tags #{aidbox.sdc/Launch}
  :document AdvancedIllnessAndFrailtyDocument
  :params {:encounter-id {:type zen/string}}
  :populate-engine aidbox.sdc/LispPopulate
  :populate {:author    (get-in [:ctx :user])
             :encounter {:id (get-in [:params :encounter-id]) :resourceType "Encounter"}
             :patient   (sql {:select [:#> :resource [:subject]]
                              :from :Encounter
                              :where [:= :id (get-in [:params :encounter-id])]})
             :advanced-illness-diagnoses (sql {:select [:#> :resource [:advanced-illness-diagnoses]]
                                               :from :SDCDocument
                                               :where [:and
                                                       [:= [:#>> :resource [:status]] "completed"]
                                                       [:= [:#>> :resource [:form :form]] "aidbox.forms.advanced-illness-and-frailty/AdvancedIllnessAndFrailtyForm"]]
                                               :order-by [:pg/desc :ts]
                                               :limit 1})
             :frailty-diagnoses (sql {:select [:#> :resource [:frailty-diagnoses]]
                                      :from :SDCDocument
                                      :where [:and
                                              [:= [:#>> :resource [:status]] "completed"]
                                              [:= [:#>> :resource [:form :form]] "aidbox.forms.advanced-illness-and-frailty/AdvancedIllnessAndFrailtyForm"]]
                                      :order-by [:pg/desc :ts]
                                      :limit 1})
             }}


 AdvancedIllnessAndFrailtyForm
 {:zen/tags #{aidbox.sdc/Form}
  :title    "Advanced Illness & Frailty"
  :properties {:form-type "Evaluation of Mental Disorders"}
  :document AdvancedIllnessAndFrailtyDocument
  :layout   AdvancedIllnessAndFrailtyLayout
  :launch   AdvancedIllnessAndFrailtyLaunch}}
